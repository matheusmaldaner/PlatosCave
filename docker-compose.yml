version: '3.9'

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "5001:5001"
    environment:
      - BROWSER_USE_API_KEY=${BROWSER_USE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PLATOS_CAVE_API_KEY=${PLATOS_CAVE_API_KEY}
      - REMOTE_BROWSER_CDP_INTERNAL_URL=http://remote-browser:9222
      - REMOTE_BROWSER_NOVNC_INTERNAL_URL=http://remote-browser:7900
      - REMOTE_BROWSER_CDP_PUBLIC_URL=http://localhost:9222
      - REMOTE_BROWSER_NOVNC_PUBLIC_URL=http://localhost:7900/vnc.html?autoconnect=1&resize=scale
    depends_on:
      - remote-browser
    networks:
      - cave-net

  remote-browser:
    build:
      context: ./backend/docker/remote-browser
      dockerfile: Dockerfile
    ports:
      - "9222:9222"
      - "7900:7900"
    environment:
      CDP_PORT: 9222
      VNC_PORT: 5900
      NOVNC_PORT: 7900
      CHROME_START_URL: "about:blank"
    # CRITICAL: Chrome requires shared memory - without this it WILL crash
    shm_size: "2gb"
    # Auto-restart on crash
    restart: unless-stopped
    # Health check to detect unresponsive browser
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9222/json/version || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 20s
    # Memory limits to prevent OOM crashes
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    networks:
      - cave-net

networks:
  cave-net:
    driver: bridge
