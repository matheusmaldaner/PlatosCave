services:
  frontend:
    image: ghcr.io/matheusmaldaner/platoscave/platoscave-frontend:latest
    ports:
      - "3000:80"
    environment:
      GATSBY_API_URL: https://platoscave.matheus.wiki
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - platoscave-net
    restart: unless-stopped

  backend:
    image: ghcr.io/matheusmaldaner/platoscave/platoscave-backend:latest
    ports:
      - "5001:5001"
    environment:
      ALLOWED_ORIGINS: https://platoscave.matheus.wiki,http://localhost
      REMOTE_BROWSER_CDP_INTERNAL_URL: http://remote-browser:9222
      REMOTE_BROWSER_CDP_PUBLIC_URL: https://platoscave.matheus.wiki/cdp
      REMOTE_BROWSER_NOVNC_INTERNAL_URL: http://remote-browser:7900
      REMOTE_BROWSER_NOVNC_PUBLIC_URL: https://platoscave.matheus.wiki/vnc/vnc.html?autoconnect=1&resize=scale
      BROWSER_USE_API_KEY: <YOUR_BROWSER_USE_API_KEY>
      EXA_API_KEY: <YOUR_EXA_API_KEY>
      SUPPRESS_LOGS: false
    depends_on:
      remote-browser:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:5001/health'', timeout=2).read()"',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - platoscave-net
    restart: unless-stopped

  remote-browser:
    image: ghcr.io/matheusmaldaner/platoscave/platoscave-remote-browser:latest
    ports:
      - "9222:9222"
      - "7900:7900"
    environment:
      CDP_PORT: 9222
      VNC_PORT: 5900
      NOVNC_PORT: 7900
      CHROME_START_URL: "about:blank"
    shm_size: "4gb"
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS -H 'Host: localhost' http://localhost:9222/json/version || exit 1",
        ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - platoscave-net

networks:
  platoscave-net:
    driver: bridge
